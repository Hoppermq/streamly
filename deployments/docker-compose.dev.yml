# Development Docker Compose Configuration
# Optimized for local development with hot reload and debugging

services:
  frontend:
    build:
      context: ../
      dockerfile: docker/frontend.Dockerfile
      target: development
      args:
        BUILD_TARGET: development
        BUN_VERSION: 1.0
    ports:
      - "3000:3000"
    volumes:
      - ../frontend:/app
      - /app/node_modules
      - bun_cache:/root/.bun
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://api.localhost:8080
      - VITE_ZITADEL_ISSUER=http://auth.localhost:8080
      - VITE_ZITADEL_CLIENT_ID=${WEB_OIDC_CLIENT_ID}
      - VITE_ZITADEL_PROJECT_ID=${ZITADEL_PROJECT_ID}
      - VITE_APP_ENV=development
    env_file:
      - .env.zitadel
    depends_on:
      - ingestor-service
      - query-service
      - zitadel
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ingestor-service:
    build:
      context: ../
      dockerfile: docker/services.dev.Dockerfile
      target: development
      args:
        TARGET_OS: linux
        TARGET_ARCH: amd64
    ports:
      - "8091:8091"
    volumes:
      - ../:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    environment:
      - GO_ENV=development
      - PORT=8091
      - CONFIG_PATH=/app/conf/config.dev.toml
      - SERVICE_PATH=./cmd/ingestion
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ingestor.rule=Host(`ingestor.localhost`)"
      - "traefik.http.routers.ingestor.entrypoints=web"
      - "traefik.http.services.ingestor.loadbalancer.server.port=8091"
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8091/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      clickhouse:
        condition: "service_healthy"
      postgres:
        condition: "service_healthy"
      streamly:
        condition: service_healthy

  query-service:
    build:
      context: ../
      dockerfile: docker/services.dev.Dockerfile
      target: development
      args:
        TARGET_OS: linux
        TARGET_ARCH: amd64
    ports:
      - "8092:8092"
    volumes:
      - ../:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    environment:
      - GO_ENV=development
      - PORT=8092
      - CONFIG_PATH=/app/conf/config.dev.toml
      - SERVICE_PATH=./cmd/query-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.query.rule=Host(`query.localhost`)"
      - "traefik.http.routers.query.entrypoints=web"
      - "traefik.http.services.query.loadbalancer.server.port=8092"
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8092/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      clickhouse:
        condition: "service_healthy"
      postgres:
        condition: "service_healthy"
      streamly:
        condition: service_healthy

  auth-service:
    build:
      context: ../
      dockerfile: docker/services.dev.Dockerfile
      target: development
      args:
        TARGET_OS: linux
        TARGET_ARCH: amd64
    ports:
      - "8093:8093"
    volumes:
      - ../:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    environment:
      - GO_ENV=dev
      - PORT=8093
      - CONFIG_PATH=/app/conf/config.dev.toml
      - SERVICE_PATH=./cmd/auth
    networks:
      - streamly-dev
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      streamly:
        condition: service_healthy

  streamly:
    build:
      context: ../
      dockerfile: docker/services.dev.Dockerfile
      target: development
      args:
        TARGET_OS: linux
        TARGET_ARCH: amd64
    ports:
      - "8094:8094"
    volumes:
      - ../:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    env_file:
      - .env.zitadel
    environment:
      - GO_ENV=development
      - PORT=8094
      - CONFIG_PATH=/app/conf/config.dev.toml
      - SERVICE_PATH=./cmd/platform
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.platform.rule=Host(`api.localhost`)"
      - "traefik.http.routers.platform.entrypoints=web"
      - "traefik.http.services.platform.loadbalancer.server.port=8094"
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8094/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      postgres:
        condition: service_healthy
      zitadel-bootstrap:
        condition: service_completed_successfully

  zitadel:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel:latest
    command: "start-from-init --config /init-config.yml --steps /init-steps-config.yml --masterkeyFromEnv --tlsMode disabled"
    volumes:
      - "./zitadel/init-config.dev.yml:/init-config.yml:ro"
      - "./zitadel/init-steps-config.dev.yml:/init-steps-config.yml:ro"
      - "./zitadel/machinekey:/machinekey"
    environment:
      - ZITADEL_MASTERKEY=masterKeyShouldLast32Characters!
      - ZITADEL_TLS_ENABLED=false
      - ZITADEL_FIRSTINSTANCE_MACHINEKEYPATH=/machinekey/zitadel-admin-sa.json
      - ZITADEL_FIRSTINSTANCE_PATPATH=/machinekey/zitadel-admin.pat
      - ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED=false
      - ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH=/machinekey/login-client.pat
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME=login-client
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME=Automatically Initialized IAM_LOGIN_CLIENT
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE=2029-01-01T00:00:00Z
      - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=false
    depends_on:
      postgres:
        condition: "service_healthy"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "/app/zitadel", "ready"]
      interval: 10s
      timeout: 60s
      retries: 5
      start_period: 10s
    networks:
      - zitadel
      - streamly-dev
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=streamly-dev"
      - "traefik.http.routers.zitadel.rule=Host(`auth.localhost`)"
      - "traefik.http.routers.zitadel.entrypoints=web"
      - "traefik.http.services.zitadel.loadbalancer.server.port=8080"
      - "traefik.http.services.zitadel.loadbalancer.server.scheme=h2c"
      - "traefik.http.middlewares.zitadel-headers.headers.customrequestheaders.X-Forwarded-Proto=http"
      - "traefik.http.middlewares.zitadel-headers.headers.customrequestheaders.X-Forwarded-Host=auth.localhost:8080"
      - "traefik.http.routers.zitadel.middlewares=zitadel-headers"
    user: "0"

  # zitadel-login: Disabled for development - using built-in Zitadel login UI
  # To enable, uncomment and set ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=true
  # zitadel-login:
  #   restart: unless-stopped
  #   image: ghcr.io/zitadel/zitadel-login:latest
  #   environment:
  #     - ZITADEL_API_URL=http://zitadel:8080
  #     - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
  #     - ZITADEL_SERVICE_USER_TOKEN_FILE=/machinekey/login-client.pat
  #   volumes:
  #     - "./zitadel/machinekey:/machinekey:ro"
  #   networks:
  #     - zitadel
  #     - streamly-dev
  #   user: "0"
  #   depends_on:
  #     zitadel:
  #       condition: service_healthy
  #   ports:
  #     - "3003:3000"
  #   healthcheck:
  #     test:
  #       [
  #         "CMD",
  #         "wget",
  #         "--no-verbose",
  #         "--tries=1",
  #         "--spider",
  #         "http://localhost:3000/health",
  #       ]
  #     interval: 10s
  #     timeout: 30s
  #     retries: 5
  #     start_period: 20s

  zitadel-bootstrap:
    image: hashicorp/terraform:1.14
    platform: linux/amd64
    volumes:
      - ./:/deployments
      - "./zitadel/machinekey:/machinekey:ro"
      - terraform_plugins:/root/.terraform.d/plugin-cache
    working_dir: /deployments
    environment:
      - ZITADEL_URL=http://auth.localhost:8080
      - ZITADEL_DOMAIN=auth.localhost
      - ZITADEL_PORT=8080
      - ZITADEL_PAT_FILE=/machinekey/zitadel-admin.pat
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache bash wget jq git
        /deployments/scripts/bootstrap-zitadel.sh
    depends_on:
      zitadel:
        condition: service_healthy
    networks:
      - zitadel
      - streamly-dev
    restart: "no"

  rabbitmq:
    image: rabbitmq:latest
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=dev
      - RABBITMQ_DEFAULT_PASS=password
    volumes:
      - rabbitmq-lib:/var/lib/rabbitmq/
      - rabbitmq-log:/var/log/rabbitmq
    networks:
      - streamly-dev

  redis:
    image: redis:8-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:17.7-alpine
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../scripts/sql/:/docker-entrypoint-initdb.d/
    environment:
      - POSTGRES_DB=streamly_dev
      - POSTGRES_USER=streamly
      - POSTGRES_PASSWORD=dev_password_123
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U streamly -d streamly_dev"]
      interval: 30s
      timeout: 10s
      retries: 3

  clickhouse:
    image: clickhouse/clickhouse-server
    ports:
      - "5342:9000" # TCP native protocol port (remapped from 9000 to follow PostgreSQL-like convention)
      - "9000:8123" # HTTP API port (remapped from 8123 for consistency)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=streamly_analytics
      - CLICKHOUSE_USER=streamly
      - CLICKHOUSE_PASSWORD=dev_clickhouse_123
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    networks:
      - streamly-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  clickhouse-ui:
    image: spoonest/clickhouse-tabix-web-client:stable
    ports:
      - "8124:80"
    healthcheck:
      test: ["CMD", "echo", "ok"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - streamly-dev
    restart: unless-stopped

  adminer:
    image: adminer:5.4.1
    ports:
      - "8081:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
    depends_on:
      - postgres
    networks:
      - streamly-dev
    restart: unless-stopped

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Web UI
    networks:
      - streamly-dev
    restart: unless-stopped

  traefik:
    image: "traefik:v3.6.7"
    container_name: "traefik"
    security_opt:
      - no-new-privileges:true
    command:
      - --configFile=/etc/traefik.toml
    ports:
      - "8080:8080"
      - "8888:8888"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/traefik.dev.toml:/etc/traefik.toml:ro"
    restart: unless-stopped
    networks:
      streamly-dev:
        aliases:
          - auth.localhost
          - api.localhost
          - ingestor.localhost
          - query.localhost
      zitadel:
        aliases:
          - auth.localhost

configs:
  rabbitmq-plugins:
    content: "[rabbitmq_management]."

networks:
  streamly-dev:
    driver: bridge
    name: streamly-dev
  zitadel:
    driver: bridge
    name: zitadel

volumes:
  postgres_data:
    driver: local
    name: streamly-dev-postgres
  clickhouse_data:
    driver: local
    name: streamly-dev-clickhouse
  rabbitmq-lib:
    driver: local
    name: streamly-dev-rabbitmq-lib
  rabbitmq-log:
    driver: local
    name: streamly-dev-rabbitmq-log
  redis_data:
    driver: local
    name: streamly-dev-redis
  bun_cache:
    driver: local
    name: streamly-dev-bun-cache
  go_mod_cache:
    driver: local
    name: streamly-dev-go-mod
  go_build_cache:
    driver: local
    name: streamly-dev-go-build
  zitadel_machinekey:
    driver: local
    name: streamly-dev-zitadel-machinekey
  terraform_plugins:
    driver: local
    name: streamly-dev-terraform-plugins
